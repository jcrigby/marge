<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MARGE — Day in the Life</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', monospace;
  background: #ffffff; color: #24292f;
  overflow: hidden; height: 100vh;
}

/* ── Header ────────────────────────────────── */
.header {
  background: #f6f8fa; border-bottom: 1px solid #d0d7de;
  padding: 8px 20px; display: flex; align-items: center; gap: 16px;
  height: 44px;
}
.header h1 { font-size: 16px; font-weight: 700; color: #1f2328; }
.sim-time { font-size: 20px; font-weight: 700; color: #0969da; letter-spacing: 1px; }
.speed-badge {
  font-size: 11px; padding: 2px 8px; border-radius: 10px;
  background: #0550ae33; color: #0969da; font-weight: 600;
}
.chapter-badge {
  font-size: 11px; padding: 2px 10px; border-radius: 10px;
  background: #1a7f37; color: #fff; font-weight: 600;
  text-transform: uppercase; letter-spacing: 1px;
}
.status { font-size: 11px; padding: 2px 8px; border-radius: 10px; }
.status.connected { background: #dafbe1; color: #0e8a8a; }
.status.disconnected { background: #ffebe9; color: #cf222e; }

/* ── Annotation Banner ────────────────────── */
.annotation-banner {
  background: #0550ae22; border-bottom: 1px solid #0550ae44;
  padding: 6px 20px; font-size: 14px; color: #1f2328;
  text-align: center; font-weight: 600; letter-spacing: 0.5px;
  height: 32px; line-height: 20px; overflow: hidden;
  transition: opacity 0.5s;
}
.annotation-banner.empty { opacity: 0.3; }

/* ── Main Layout ─────────────────────────── */
.main { display: flex; height: calc(100vh - 44px - 32px - 100px); }
.house-area { flex: 1; padding: 12px 16px; overflow: hidden; }
.sidebar { width: 320px; background: #f6f8fa; border-left: 1px solid #d0d7de; overflow-y: auto; padding: 12px; }

/* ── ASCII House ─────────────────────────── */
.house {
  font-size: 13px; line-height: 1.5; white-space: pre;
  font-family: 'SF Mono', 'Cascadia Code', monospace;
}
.dim { color: #8c959f; }
.bright { color: #9a6700; }
.green { color: #1a7f37; }
.red { color: #cf222e; }
.cyan { color: #0e8a8a; }
.blue { color: #0969da; }
.purple { color: #8250df; }
.white { color: #1f2328; }
.gray { color: #8c959f; }
.orange { color: #bc4c00; }
.flash { animation: flash 0.8s infinite; }
@keyframes flash { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

.room-label { color: #656d76; font-weight: 700; }
.border-char { color: #afb8c1; }

/* ── Metrics Panel ───────────────────────── */
.metrics-section { margin-bottom: 16px; }
.metrics-section h3 {
  font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px;
  color: #656d76; margin-bottom: 8px; font-weight: 600;
}
.metric-row {
  display: flex; align-items: center; margin-bottom: 6px; font-size: 12px;
}
.metric-label { width: 80px; color: #656d76; flex-shrink: 0; }
.metric-bars { flex: 1; display: flex; gap: 4px; align-items: center; }
.bar-group { flex: 1; }
.bar-label { font-size: 10px; color: #656d76; margin-bottom: 1px; }
.bar-track { height: 14px; background: #eaeef2; border-radius: 3px; position: relative; overflow: hidden; }
.bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s; }
.bar-fill.ha { background: #bc4c00; }
.bar-fill.marge { background: #0969da; }
.bar-value {
  position: absolute; right: 4px; top: 0; line-height: 14px;
  font-size: 10px; color: #1f2328; font-weight: 600;
}

/* ── Event Log ───────────────────────────── */
.event-log { font-size: 11px; max-height: 200px; overflow-y: auto; }
.log-entry { padding: 2px 0; border-bottom: 1px solid #eaeef2; display: flex; gap: 4px; align-items: baseline; }
.log-time { color: #8c959f; flex-shrink: 0; }
.log-auto { color: #8250df; }
.log-state { color: #0969da; }
.log-verify { color: #1a7f37; }
.log-source { font-size: 9px; padding: 0 3px; border-radius: 2px; font-weight: 700; flex-shrink: 0; }
.log-source.ha { background: #bc4c0022; color: #bc4c00; }
.log-source.marge { background: #0969da22; color: #0969da; }
.log-source.sys { background: #cf222e22; color: #cf222e; }
.log-domain-icon { flex-shrink: 0; width: 14px; text-align: center; }
.log-msg { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.log-entry.automation { border-left: 2px solid #8250df; padding-left: 4px; }
.log-entry.outage { border-left: 2px solid #cf222e; padding-left: 4px; background: #cf222e08; }
.event-rate { font-size: 11px; color: #1a7f37; float: right; font-weight: 600; }

/* ── Timeline ────────────────────────────── */
.timeline {
  height: 100px; background: #f6f8fa; border-top: 1px solid #d0d7de;
  padding: 10px 20px;
}
.timeline h3 {
  font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px;
  color: #656d76; margin-bottom: 6px;
}
.timeline-track {
  position: relative; height: 24px; background: #eaeef2;
  border-radius: 4px; margin-bottom: 6px;
}
.timeline-fill {
  height: 100%; background: linear-gradient(90deg, #0550ae, #0969da);
  border-radius: 4px; transition: width 0.5s;
}
.timeline-marker {
  position: absolute; top: -4px; width: 2px; height: 32px;
  background: #d0d7de;
}
.timeline-marker-label {
  position: absolute; top: 28px; font-size: 9px; color: #656d76;
  transform: translateX(-50%); white-space: nowrap;
}
.timeline-labels {
  display: flex; justify-content: space-between; font-size: 10px; color: #8c959f;
}
.timeline-chapters {
  display: flex; gap: 4px; margin-top: 4px;
}
.timeline-chapter {
  font-size: 9px; padding: 1px 6px; border-radius: 3px;
  background: #eaeef2; color: #656d76; cursor: pointer;
}
.timeline-chapter.active { background: #0550ae; color: #fff; }

/* ── Score Card Overlay ─────────────── */
.scorecard-overlay {
  display: none; position: fixed; inset: 0; z-index: 1000;
  background: rgba(0,0,0,0.5); justify-content: center; align-items: center;
}
.scorecard-overlay.visible { display: flex; }
.scorecard {
  background: #f6f8fa; border: 2px solid #d0d7de; border-radius: 12px;
  padding: 32px 48px; max-width: 880px; width: 90%;
}
.scorecard h2 {
  font-size: 22px; color: #1f2328; text-align: center;
  margin-bottom: 6px; font-weight: 700; letter-spacing: 1px;
}
.scorecard .subtitle {
  font-size: 12px; color: #656d76; text-align: center; margin-bottom: 24px;
}
.sc-table { width: 100%; border-collapse: collapse; }
.sc-table th {
  font-size: 11px; text-transform: uppercase; letter-spacing: 1px;
  color: #656d76; padding: 6px 12px; text-align: right;
  border-bottom: 1px solid #d0d7de;
}
.sc-table th:first-child { text-align: left; }
.sc-table td { padding: 10px 12px; text-align: right; font-size: 15px; }
.sc-table td:first-child {
  text-align: left; color: #656d76; font-size: 13px; font-weight: 600;
}
.sc-table .ha-col { color: #bc4c00; }
.sc-table .slim-col { color: #9a6700; }
.sc-table .marge-col { color: #0969da; }
.sc-table .ratio-col { color: #1a7f37; font-weight: 700; font-size: 13px; }
.sc-table tr { border-bottom: 1px solid #eaeef2; }
.sc-table tr:last-child { border-bottom: none; }
.sc-footer {
  margin-top: 20px; text-align: center; font-size: 11px; color: #8c959f;
}
.sc-dismiss {
  margin-top: 12px; text-align: center; font-size: 10px; color: #8c959f;
}

/* ── Outage Overlay ──────────────────── */
.outage-overlay {
  display: none; position: fixed; inset: 0; z-index: 900;
  background: rgba(0,0,0,0.7); justify-content: center; align-items: center;
  flex-direction: column;
}
.outage-overlay.visible { display: flex; }
.outage-icon {
  font-size: 72px; margin-bottom: 16px;
  animation: outage-pulse 1.5s ease-in-out infinite;
}
@keyframes outage-pulse {
  0%,100% { opacity: 0.3; } 50% { opacity: 1; }
}
.outage-title {
  font-size: 36px; font-weight: 900; color: #cf222e;
  letter-spacing: 4px; margin-bottom: 8px;
}
.outage-sub {
  font-size: 14px; color: #656d76; margin-bottom: 32px;
}
.recovery-race {
  display: flex; gap: 48px; align-items: flex-start;
}
.recovery-lane {
  text-align: center; min-width: 200px;
}
.recovery-lane h3 {
  font-size: 14px; font-weight: 700; letter-spacing: 1px; margin-bottom: 12px;
}
.recovery-lane.ha h3 { color: #bc4c00; }
.recovery-lane.marge h3 { color: #0969da; }
.recovery-timer {
  font-size: 48px; font-weight: 900; font-variant-numeric: tabular-nums;
}
.recovery-timer.waiting { color: #8c959f; }
.recovery-timer.recovering { color: #9a6700; }
.recovery-timer.recovered { color: #1a7f37; }
.recovery-label {
  font-size: 12px; color: #656d76; margin-top: 8px; min-height: 20px;
}
.recovery-vs {
  font-size: 28px; color: #d0d7de; align-self: center; font-weight: 900;
}
</style>
</head>
<body>

<!-- ── Header ──────────────────────────────── -->
<div class="header">
  <h1>MARGE</h1>
  <span class="sim-time" id="sim-time">--:--:--</span>
  <span class="speed-badge" id="speed-badge">10x</span>
  <span class="chapter-badge" id="chapter-badge">IDLE</span>
  <span style="flex:1"></span>
  <span id="ha-status" class="status disconnected">HA: --</span>
  <span id="marge-status" class="status disconnected">Marge: --</span>
</div>

<!-- ── Annotation Banner ───────────────────── -->
<div class="annotation-banner empty" id="annotation-banner">Waiting for scenario...</div>

<!-- ── Main Content ────────────────────────── -->
<div class="main">
  <!-- ASCII House -->
  <div class="house-area">
    <div class="house" id="house"></div>
  </div>

  <!-- Sidebar: Metrics + Log -->
  <div class="sidebar">
    <!-- Metrics Comparison -->
    <div class="metrics-section">
      <h3>HA-legacy vs Marge</h3>

      <div class="metric-row">
        <span class="metric-label">Memory</span>
        <div class="metric-bars">
          <div class="bar-group">
            <div class="bar-label">HA</div>
            <div class="bar-track"><div class="bar-fill ha" id="ha-mem-bar" style="width:0%"></div><span class="bar-value" id="ha-mem-val">--</span></div>
          </div>
          <div class="bar-group">
            <div class="bar-label">Marge</div>
            <div class="bar-track"><div class="bar-fill marge" id="marge-mem-bar" style="width:0%"></div><span class="bar-value" id="marge-mem-val">--</span></div>
          </div>
        </div>
      </div>

      <div class="metric-row">
        <span class="metric-label">Latency</span>
        <div class="metric-bars">
          <div class="bar-group">
            <div class="bar-label">HA</div>
            <div class="bar-track"><div class="bar-fill ha" id="ha-lat-bar" style="width:0%"></div><span class="bar-value" id="ha-lat-val">--</span></div>
          </div>
          <div class="bar-group">
            <div class="bar-label">Marge</div>
            <div class="bar-track"><div class="bar-fill marge" id="marge-lat-bar" style="width:0%"></div><span class="bar-value" id="marge-lat-val">--</span></div>
          </div>
        </div>
      </div>

      <div class="metric-row">
        <span class="metric-label">Startup</span>
        <div class="metric-bars">
          <div class="bar-group">
            <div class="bar-label">HA</div>
            <div class="bar-track"><div class="bar-fill ha" id="ha-start-bar" style="width:0%"></div><span class="bar-value" id="ha-start-val">~94s</span></div>
          </div>
          <div class="bar-group">
            <div class="bar-label">Marge</div>
            <div class="bar-track"><div class="bar-fill marge" id="marge-start-bar" style="width:0%"></div><span class="bar-value" id="marge-start-val">--</span></div>
          </div>
        </div>
      </div>

      <div class="metric-row">
        <span class="metric-label">Events</span>
        <div class="metric-bars">
          <div class="bar-group">
            <div class="bar-track" style="background:transparent;height:auto">
              <span style="font-size:18px;color:#bc4c00;font-weight:700" id="ha-events">0</span>
              <span style="font-size:10px;color:#656d76"> HA</span>
            </div>
          </div>
          <div class="bar-group">
            <div class="bar-track" style="background:transparent;height:auto">
              <span style="font-size:18px;color:#0969da;font-weight:700" id="marge-events">0</span>
              <span style="font-size:10px;color:#656d76"> Marge</span>
            </div>
          </div>
        </div>
      </div>

      <div class="metric-row">
        <span class="metric-label">Verify</span>
        <div class="metric-bars">
          <div class="bar-group">
            <div class="bar-track" style="background:transparent;height:auto">
              <span style="font-size:14px;color:#bc4c00;font-weight:700" id="ha-verify">--</span>
            </div>
          </div>
          <div class="bar-group">
            <div class="bar-track" style="background:transparent;height:auto">
              <span style="font-size:14px;color:#0969da;font-weight:700" id="marge-verify">--</span>
            </div>
          </div>
        </div>
      </div>

      <div class="metric-row">
        <span class="metric-label">Uptime</span>
        <div class="metric-bars">
          <div class="bar-group">
            <div class="bar-track" style="background:transparent;height:auto">
              <span style="font-size:12px;color:#bc4c00" id="ha-uptime">--</span>
            </div>
          </div>
          <div class="bar-group">
            <div class="bar-track" style="background:transparent;height:auto">
              <span style="font-size:12px;color:#0969da" id="marge-uptime">--</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- State Diffs -->
    <div class="metrics-section">
      <h3>State Diffs <span id="diff-summary" style="color:#0969da"></span></h3>
      <div id="diff-list" style="max-height:120px;overflow-y:auto"></div>
    </div>

    <!-- Event Log -->
    <div class="metrics-section">
      <h3>Event Stream <span class="event-rate" id="event-rate"></span></h3>
      <div class="event-log" id="event-log"></div>
    </div>
  </div>
</div>

<!-- ── Timeline ────────────────────────────── -->
<div class="timeline">
  <h3>Timeline</h3>
  <div class="timeline-track" id="timeline-track">
    <div class="timeline-fill" id="timeline-fill" style="width:0%"></div>
  </div>
  <div class="timeline-labels">
    <span>00:00</span><span>06:00</span><span>12:00</span><span>18:00</span><span>24:00</span>
  </div>
  <div class="timeline-chapters" id="timeline-chapters"></div>
</div>

<!-- ── Score Card Overlay ──────────────────── -->
<div class="scorecard-overlay" id="scorecard-overlay">
  <div class="scorecard">
    <h2>SCORE CARD</h2>
    <div class="subtitle">Day in the Life — Final Metrics</div>
    <table class="sc-table">
      <thead>
        <tr><th>Metric</th><th>HA Stock</th><th>HA Slim</th><th>Marge</th><th>Ratio</th></tr>
      </thead>
      <tbody id="sc-body"></tbody>
    </table>
    <div class="sc-footer">Same events. Same automations. Same outcomes.</div>
    <div class="sc-dismiss">Press S or click to dismiss</div>
  </div>
</div>

<!-- ── Outage Overlay ─────────────────────── -->
<div class="outage-overlay" id="outage-overlay">
  <div class="outage-icon">&#x26A0;</div>
  <div class="outage-title">POWER OUTAGE</div>
  <div class="outage-sub">Simulated power failure — recovery race in progress</div>
  <div class="recovery-race">
    <div class="recovery-lane ha">
      <h3>HA-legacy</h3>
      <div class="recovery-timer waiting" id="ha-recovery-timer">--.-s</div>
      <div class="recovery-label" id="ha-recovery-label">Waiting...</div>
    </div>
    <div class="recovery-vs">vs</div>
    <div class="recovery-lane marge">
      <h3>Marge</h3>
      <div class="recovery-timer waiting" id="marge-recovery-timer">--.-s</div>
      <div class="recovery-label" id="marge-recovery-label">Waiting...</div>
    </div>
  </div>
</div>

<!-- ── Help Overlay ───────────────────────── -->
<div class="scorecard-overlay" id="help-overlay">
  <div class="scorecard" style="max-width:400px">
    <h2>KEYBOARD SHORTCUTS</h2>
    <table class="sc-table" style="text-align:left">
      <tbody>
        <tr><td style="padding:6px 16px;color:#0969da;font-weight:700">S</td><td style="padding:6px 16px">Toggle score card</td></tr>
        <tr><td style="padding:6px 16px;color:#0969da;font-weight:700">?</td><td style="padding:6px 16px">Toggle this help</td></tr>
        <tr><td style="padding:6px 16px;color:#0969da;font-weight:700">Esc</td><td style="padding:6px 16px">Dismiss overlay</td></tr>
      </tbody>
    </table>
    <div class="sc-footer" style="margin-top:12px">
      Dashboard: <span style="color:#0969da">http://localhost:3000</span><br>
      HA: <span style="color:#bc4c00">http://localhost:8123</span><br>
      Marge: <span style="color:#1a7f37">http://localhost:8124</span>
    </div>
    <div class="sc-dismiss">Press ? or click to dismiss</div>
  </div>
</div>

<script>
// ── Configuration ──────────────────────────
const params = new URLSearchParams(location.search);
const HA_WS = params.get('ha_ws') || 'ws://localhost:8123/api/websocket';
const MARGE_WS = params.get('marge_ws') || 'ws://localhost:8124/api/websocket';
const MARGE_REST = params.get('marge_rest') || 'http://localhost:8124/api';
const HA_REST = params.get('ha_rest') || 'http://localhost:8123/api';
const HA_TOKEN = params.get('ha_token') || '';

// ── State ──────────────────────────────────
const S = {};  // Marge states: { entity_id: { state, attrs } }
const HA = {}; // HA states
let margeEvents = 0, haEvents = 0;
let margeHealth = {};
let haConnectTime = null;
let haLatencyMs = null;
let cachedHAToken = null;
let currentChapter = 'idle';
let simTimeStr = '--:--:--';
let eventTimestamps = []; // for events/sec calculation

// ── Outage Tracking ────────────────────────
let outageActive = false;
let outageStartTime = null;
let margeRecoveryTime = null;
let haRecoveryTime = null;
let margeWasOnline = false;
let haWasOnline = false;
let recoveryTimerInterval = null;

// Chapter definitions for timeline
const CHAPTERS = [
  { name: 'dawn',      start: '05:25', color: '#bc4c00' },
  { name: 'morning',   start: '06:10', color: '#9a6700' },
  { name: 'daytime',   start: '06:20', color: '#0969da' },
  { name: 'sunset',    start: '17:25', color: '#bc4c00' },
  { name: 'evening',   start: '17:40', color: '#8250df' },
  { name: 'goodnight', start: '21:55', color: '#8c959f' },
  { name: 'night',     start: '22:05', color: '#d0d7de' },
  { name: 'outage',    start: '03:45', color: '#cf222e' },
];

// ── Entity Renderers ────────────────────────

function getState(eid) { return S[eid] || { state: 'unknown', attrs: {} }; }

function lightIcon(eid) {
  const s = getState(eid);
  if (s.state === 'on') {
    const b = s.attrs?.brightness;
    const pct = b ? Math.round((b / 255) * 100) : 100;
    const bars = Math.round(pct / 12.5);
    const barStr = '\u2588'.repeat(bars) + '\u2591'.repeat(8 - bars);
    return `<span class="bright">\u25CF</span> <span class="bright">${barStr}</span> <span class="white">${pct}%</span>`;
  }
  return '<span class="dim">\u25CB</span> <span class="dim">off</span>';
}

function lightSimple(eid) {
  const s = getState(eid);
  if (s.state === 'on') {
    const rgb = s.attrs?.rgb_color;
    if (rgb && Array.isArray(rgb) && rgb.length === 3) {
      return `<span style="color:rgb(${rgb[0]},${rgb[1]},${rgb[2]})">\u25CF</span>`;
    }
    return '<span class="bright">\u25CF</span>';
  }
  return '<span class="dim">\u25CB</span>';
}

function switchIcon(eid) {
  const s = getState(eid);
  return s.state === 'on'
    ? '<span class="green">[ ON  ]</span>'
    : '<span class="dim">[ OFF ]</span>';
}

function lockIcon(eid) {
  const s = getState(eid);
  return s.state === 'locked'
    ? '<span class="green">\u25CF LOCKED</span>'
    : '<span class="red">\u25C6 UNLOCKED</span>';
}

function motionIcon(eid) {
  const s = getState(eid);
  return s.state === 'on'
    ? '<span class="cyan flash">\u25C6 motion</span>'
    : '<span class="dim">\u00B7 no motion</span>';
}

function doorIcon(eid) {
  const s = getState(eid);
  return s.state === 'on'
    ? '<span class="red">\u2550 \u2550 open</span>'
    : '<span class="dim">\u2550\u2550\u2550 closed</span>';
}

function tempIcon(eid) {
  const s = getState(eid);
  const v = parseFloat(s.state) || 0;
  return `<span class="white">${v.toFixed(1)}\u00B0F</span>`;
}

function humidIcon(eid) {
  const s = getState(eid);
  return `<span class="blue">${s.state}%</span>`;
}

function alarmIcon(eid) {
  const s = getState(eid);
  const icons = {
    'disarmed':    '<span class="gray">\u25CF DISARMED</span>',
    'armed_home':  '<span class="green">\u25CF ARMED_HOME</span>',
    'armed_away':  '<span class="blue">\u25CF ARMED_AWAY</span>',
    'armed_night': '<span class="purple">\u25CF ARMED_NIGHT</span>',
    'triggered':   '<span class="red flash">\u25C6 TRIGGERED</span>',
  };
  return icons[s.state] || `<span class="gray">\u25CF ${s.state}</span>`;
}

function mediaIcon(eid) {
  const s = getState(eid);
  if (s.state === 'on' || s.state === 'playing') {
    const src = s.attrs?.source || '';
    return `<span class="green">\u25B6 ${src || 'ON'}</span>`;
  }
  return '<span class="dim">\u25B7 OFF</span>';
}

function coffeeIcon(eid) {
  const s = getState(eid);
  return s.state === 'on'
    ? '<span class="orange">\u25CF BREWING</span>'
    : '<span class="dim">\u25CB OFF</span>';
}

function climateIcon(eid) {
  const s = getState(eid);
  const temp = s.attrs?.temperature;
  const setpoint = temp !== undefined ? `${temp}\u00B0F` : '--';
  if (s.state === 'heat') return `<span class="orange">\u25B2 ${setpoint}</span>`;
  if (s.state === 'cool') return `<span class="cyan">\u25BC ${setpoint}</span>`;
  if (s.state === 'off') return '<span class="dim">\u25B7 OFF</span>';
  return `<span class="white">\u25B7 ${setpoint}</span>`;
}

function smokeIcon(eid) {
  const s = getState(eid);
  return s.state === 'on'
    ? '<span class="red flash">\u25C6 ALERT</span>'
    : '<span class="dim">\u00B7</span>';
}

function sunIcon() {
  const s = getState('sun.sun');
  const rise = s.attrs?.next_rising || '--';
  const set = s.attrs?.next_setting || '--';
  const riseT = rise.includes('T') ? rise.split('T')[1]?.substring(0,5) : '--';
  const setT = set.includes('T') ? set.split('T')[1]?.substring(0,5) : '--';
  const icon = s.state === 'above_horizon' ? '\u25CF' : '\u25CB';
  return `<span class="white">${icon} Rise ${riseT} Set ${setT}</span>`;
}

function weatherIcon() {
  const s = getState('weather.home');
  const t = s.attrs?.temperature || '--';
  return `<span class="white">${s.state} ${t}\u00B0</span>`;
}

function powerIcon() {
  const p = parseFloat(getState('sensor.power_consumption').state) || 0;
  const v = parseFloat(getState('sensor.voltage').state) || 0;
  const a = parseFloat(getState('sensor.current').state) || 0;
  return `<span class="white">\u25B6 ${p}W ${v}V ${a}A</span>`;
}

function trackerIcon() {
  const s = getState('device_tracker.phone');
  return s.state === 'home'
    ? '<span class="green">\u25CF home</span>'
    : '<span class="gray">\u25CB away</span>';
}

// ── House Renderer ──────────────────────────

// Strip HTML tags to get visible character count
function visLen(html) { return html.replace(/<[^>]+>/g, '').length; }
// Pad HTML string to exact visible width
function pad(html, w) { return html + ' '.repeat(Math.max(0, w - visLen(html))); }

function renderHouse() {
  const B = '<span class="border-char">';
  const E = '</span>';
  const W = 22;           // room total width (including walls)
  const I = W - 2;        // room interior width
  const EW = W * 3 + 2;   // exterior total (3 rooms + 2 gaps)
  const EI = EW - 2;      // exterior interior
  const GAP = ' ';
  const MGAP = ' '.repeat(W + 2); // middle gap after bathroom closes

  function hdr(label, tw) {
    const d = tw - 5 - label.length; // ┌─ LABEL ─...─┐ = 5 fixed chars
    return B + '\u250C\u2500 ' + label + ' ' + '\u2500'.repeat(d) + '\u2510' + E;
  }
  function bar(tw) { return B + '\u251C' + '\u2500'.repeat(tw - 2) + '\u2524' + E; }
  function bot(tw) { return B + '\u2514' + '\u2500'.repeat(tw - 2) + '\u2518' + E; }
  function row(content) {
    return B + '\u2502' + E + pad(' ' + content, I) + B + '\u2502' + E;
  }
  function erow(content) {
    return B + '\u2502' + E + pad(' ' + content, EI) + B + '\u2502' + E;
  }

  const lines = [
    // ── Row 1: BEDROOM | BATHROOM | KITCHEN ──
    hdr('BEDROOM', W) + GAP + hdr('BATHROOM', W) + GAP + hdr('KITCHEN', W),
    row(lightIcon('light.bedroom')) + GAP +
      row(lightSimple('light.bathroom')) + GAP +
      row(lightSimple('light.kitchen')),
    row(tempIcon('sensor.bedroom_temperature') + '  ' + humidIcon('sensor.bedroom_humidity')) + GAP +
      row(tempIcon('sensor.bathroom_temperature')) + GAP +
      row(tempIcon('sensor.kitchen_temperature') + '  ' + humidIcon('sensor.kitchen_humidity')),
    row(motionIcon('binary_sensor.bedroom_motion')) + GAP +
      row(humidIcon('sensor.bathroom_humidity')) + GAP +
      row(coffeeIcon('switch.coffee_maker')),
    row('') + GAP + row('') + GAP +
      row(motionIcon('binary_sensor.kitchen_motion')),

    // ── Transition ──
    bar(W) + GAP + row('') + GAP + bar(W),
    row('<span class="room-label">ENTRYWAY</span>') + GAP +
      bot(W) + GAP +
      row('<span class="room-label">LIVING ROOM</span>'),

    // ── Row 2: ENTRYWAY | (gap) | LIVING ROOM ──
    row(lockIcon('lock.front_door')) + MGAP +
      row(lightSimple('light.living_room_main') + ' Main  ' + lightSimple('light.living_room_accent') + ' Accent'),
    row(lockIcon('lock.back_door')) + MGAP +
      row(lightSimple('light.living_room_lamp') + ' Lamp  ' + lightSimple('light.living_room_floor') + ' Floor'),
    row(motionIcon('binary_sensor.entryway_motion')) + MGAP +
      row(mediaIcon('media_player.living_room')),
    row(doorIcon('binary_sensor.front_door_contact')) + MGAP +
      row(tempIcon('sensor.living_room_temperature') + '  ' + humidIcon('sensor.living_room_humidity')),
    row(doorIcon('binary_sensor.back_door_contact')) + MGAP +
      row(motionIcon('binary_sensor.living_room_motion')),
    row(doorIcon('binary_sensor.garage_door_contact') + ' garage') + MGAP +
      row(''),
    row(tempIcon('sensor.entryway_temperature')) + MGAP +
      row(''),
    bot(W) + MGAP + bot(W),

    // ── Row 3: EXTERIOR ──
    hdr('EXTERIOR', EW),
    erow(
      lightSimple('light.porch') + ' Porch  ' +
      lightSimple('light.pathway') + ' Path   ' +
      climateIcon('climate.thermostat') + '   ' +
      alarmIcon('alarm_control_panel.home') + '   ' +
      sunIcon()),
    erow(
      tempIcon('sensor.exterior_temperature') + ' ' +
      humidIcon('sensor.exterior_humidity') + '  ' +
      powerIcon() + '  ' +
      smokeIcon('binary_sensor.smoke_detector') + '! ' +
      smokeIcon('binary_sensor.co_detector') + 'CO  ' +
      trackerIcon() + ' ' +
      weatherIcon()),
    bot(EW),
  ];

  document.getElementById('house').innerHTML = lines.join('\n');
}

// ── WebSocket ───────────────────────────────

function connectWS(url, token, name, stateMap, counterFn) {
  const statusEl = document.getElementById(`${name}-status`);
  function connect() {
    const ws = new WebSocket(url);
    ws.onmessage = (evt) => {
      const msg = JSON.parse(evt.data);
      if (msg.type === 'auth_required') {
        ws.send(JSON.stringify({ type: 'auth', access_token: token || 'test-token' }));
      } else if (msg.type === 'auth_ok') {
        statusEl.className = 'status connected';
        statusEl.textContent = `${name === 'ha' ? 'HA' : 'Marge'}: online`;
        if (name === 'ha') haConnectTime = Date.now();
        onSystemOnline(name);
        ws.send(JSON.stringify({ id: 1, type: 'subscribe_events', event_type: 'state_changed' }));
        ws.send(JSON.stringify({ id: 2, type: 'get_states' }));
      } else if (msg.type === 'result' && msg.id === 2 && msg.result) {
        for (const s of msg.result) {
          stateMap[s.entity_id] = { state: s.state, attrs: s.attributes || {} };
        }
        renderHouse();
      } else if (msg.type === 'event' && msg.event?.event_type === 'state_changed') {
        const d = msg.event.data;
        if (d.new_state) {
          stateMap[d.new_state.entity_id] = { state: d.new_state.state, attrs: d.new_state.attributes || {} };
          counterFn();
          scheduleRender();
          // Show annotation banner
          const eid = d.new_state.entity_id;
          if (eid === 'sensor.scenario_annotation' && name === 'marge') {
            const banner = document.getElementById('annotation-banner');
            banner.textContent = d.new_state.state;
            banner.classList.remove('empty');
            // Fade after 15 seconds
            clearTimeout(banner._fadeTimer);
            banner._fadeTimer = setTimeout(() => banner.classList.add('empty'), 15000);
            // Auto-show score card when scenario completes
            if (d.new_state.state.includes('Scenario Complete')) {
              setTimeout(showScoreCard, 3000);
            }
          }
          // Update live verification scores
          if (eid === 'sensor.verify_ha') {
            document.getElementById('ha-verify').textContent = d.new_state.state;
          } else if (eid === 'sensor.verify_marge') {
            document.getElementById('marge-verify').textContent = d.new_state.state;
          }
          // Structured event logging
          const domain = eid.split('.')[0];
          const oldState = d.old_state?.state;
          const newState = d.new_state.state;
          if (domain === 'automation') {
            logEvent(name, `${eid} \u2192 ${newState}`, 'automation');
          } else if (['light', 'switch', 'lock', 'alarm_control_panel', 'media_player', 'climate'].includes(domain)) {
            const arrow = oldState ? `${oldState} \u2192 ${newState}` : `\u2192 ${newState}`;
            logEvent(name, `${eid}: ${arrow}`);
          } else if (domain === 'scene') {
            logEvent(name, `${eid} activated`, 'automation');
          }
        }
      }
    };
    ws.onclose = () => {
      statusEl.className = 'status disconnected';
      statusEl.textContent = `${name === 'ha' ? 'HA' : 'Marge'}: offline`;
      onSystemOffline(name);
      // Reconnect faster during outage to detect recovery quickly
      setTimeout(connect, outageActive ? 500 : 3000);
    };
    ws.onerror = () => ws.close();
  }
  connect();
}

// ── Outage Detection + Recovery Race ─────────

function onSystemOffline(name) {
  if (name === 'marge') margeWasOnline = false;
  if (name === 'ha') haWasOnline = false;

  // Trigger outage overlay when both systems are down (and we've seen them online before)
  if (!margeWasOnline && !haWasOnline && !outageActive && (margeEvents > 0 || haEvents > 0)) {
    startOutage();
  }
}

function onSystemOnline(name) {
  if (name === 'marge') margeWasOnline = true;
  if (name === 'ha') haWasOnline = true;

  if (outageActive && outageStartTime) {
    const elapsed = (Date.now() - outageStartTime) / 1000;
    if (name === 'marge' && margeRecoveryTime === null) {
      margeRecoveryTime = elapsed;
      const timerEl = document.getElementById('marge-recovery-timer');
      timerEl.textContent = margeRecoveryTime.toFixed(1) + 's';
      timerEl.className = 'recovery-timer recovered';
      document.getElementById('marge-recovery-label').textContent = 'RECOVERED';
      logEvent('marge', `Recovered in ${margeRecoveryTime.toFixed(1)}s`, 'outage');
    }
    if (name === 'ha' && haRecoveryTime === null) {
      haRecoveryTime = elapsed;
      const timerEl = document.getElementById('ha-recovery-timer');
      timerEl.textContent = haRecoveryTime.toFixed(1) + 's';
      timerEl.className = 'recovery-timer recovered';
      document.getElementById('ha-recovery-label').textContent = 'RECOVERED';
      logEvent('ha', `Recovered in ${haRecoveryTime.toFixed(1)}s`, 'outage');
    }

    // Both recovered — dismiss overlay after 5 seconds
    if (margeRecoveryTime !== null && haRecoveryTime !== null) {
      clearInterval(recoveryTimerInterval);
      setTimeout(() => {
        document.getElementById('outage-overlay').classList.remove('visible');
        outageActive = false;
      }, 5000);
    }
  }
}

function startOutage() {
  outageActive = true;
  outageStartTime = Date.now();
  margeRecoveryTime = null;
  haRecoveryTime = null;

  const overlay = document.getElementById('outage-overlay');
  overlay.classList.add('visible');

  // Reset timer displays
  const margeTimer = document.getElementById('marge-recovery-timer');
  const haTimer = document.getElementById('ha-recovery-timer');
  margeTimer.textContent = '0.0s';
  margeTimer.className = 'recovery-timer recovering';
  haTimer.textContent = '0.0s';
  haTimer.className = 'recovery-timer recovering';
  document.getElementById('marge-recovery-label').textContent = 'Recovering...';
  document.getElementById('ha-recovery-label').textContent = 'Recovering...';

  logEvent('sys', 'POWER OUTAGE — systems down', 'outage');

  // Live-update timers
  recoveryTimerInterval = setInterval(() => {
    const elapsed = (Date.now() - outageStartTime) / 1000;
    if (margeRecoveryTime === null) {
      document.getElementById('marge-recovery-timer').textContent = elapsed.toFixed(1) + 's';
    }
    if (haRecoveryTime === null) {
      document.getElementById('ha-recovery-timer').textContent = elapsed.toFixed(1) + 's';
    }
  }, 100);
}

// ── Render Throttling ───────────────────────
let renderPending = false;
function scheduleRender() {
  if (!renderPending) {
    renderPending = true;
    requestAnimationFrame(() => {
      renderPending = false;
      renderHouse();
      renderDiffs();
      renderMetrics();
    });
  }
}

// ── Diffs ───────────────────────────────────

function renderDiffs() {
  const allIds = new Set([...Object.keys(HA), ...Object.keys(S)]);
  let matches = 0, mismatches = 0;
  let html = '';
  for (const eid of [...allIds].sort()) {
    if (eid.startsWith('test.') || eid.startsWith('persistent_notification.') ||
        eid.startsWith('sensor.perf_') || eid.startsWith('sensor.test_') ||
        eid === 'sensor.scenario_annotation' || eid.startsWith('sensor.verify_')) continue;
    const ha = HA[eid];
    const marge = S[eid];
    if (!ha || !marge) continue;
    if (ha.state === marge.state) { matches++; }
    else {
      mismatches++;
      html += `<div style="font-size:11px;padding:2px 0;border-left:3px solid #cf222e;padding-left:6px;margin-bottom:3px">
        <span class="blue">${eid}</span><br>
        <span class="gray">HA:</span> ${ha.state} <span class="gray">Marge:</span> ${marge.state}
      </div>`;
    }
  }
  document.getElementById('diff-list').innerHTML = html || '<span class="dim" style="font-size:11px">States match</span>';
  document.getElementById('diff-summary').textContent = `${matches} match, ${mismatches} diff`;
}

// ── Metrics ─────────────────────────────────

function renderMetrics() {
  const h = margeHealth;
  if (h.memory_rss_mb !== undefined) {
    const memPct = Math.min((h.memory_rss_mb / 1024) * 100, 100);
    document.getElementById('marge-mem-bar').style.width = memPct + '%';
    document.getElementById('marge-mem-val').textContent = h.memory_rss_mb.toFixed(1) + ' MB';
  }
  if (h.latency_avg_us !== undefined) {
    const latPct = Math.min((h.latency_avg_us / 50000) * 100, 100);
    document.getElementById('marge-lat-bar').style.width = latPct + '%';
    document.getElementById('marge-lat-val').textContent = h.latency_avg_us.toFixed(1) + ' \u00B5s';
  }
  if (h.uptime_seconds !== undefined) {
    const mins = Math.floor(h.uptime_seconds / 60);
    const secs = h.uptime_seconds % 60;
    document.getElementById('marge-uptime').textContent = `${mins}m ${secs}s`;
    // Startup bar (real measurement from health endpoint)
    const startMs = h.startup_ms || 0;
    document.getElementById('marge-start-bar').style.width = '1%';
    document.getElementById('marge-start-val').textContent = startMs < 1 ? '<1ms' : `${startMs.toFixed(1)}ms`;
  }

  // HA bars (memory measured from Docker rehearsal: docker stats marge-demo-ha)
  document.getElementById('ha-mem-bar').style.width = '16%';
  document.getElementById('ha-mem-val').textContent = '~160 MB';
  if (haLatencyMs !== null) {
    const haLatPct = Math.min((haLatencyMs / 100) * 100, 100);
    document.getElementById('ha-lat-bar').style.width = haLatPct + '%';
    document.getElementById('ha-lat-val').textContent = haLatencyMs.toFixed(0) + ' ms';
  } else {
    document.getElementById('ha-lat-bar').style.width = '46%';
    document.getElementById('ha-lat-val').textContent = '~23 ms';
  }
  document.getElementById('ha-start-bar').style.width = '94%';

  if (haConnectTime) {
    const haSecs = Math.floor((Date.now() - haConnectTime) / 1000);
    const haMins = Math.floor(haSecs / 60);
    document.getElementById('ha-uptime').textContent = `${haMins}m ${haSecs % 60}s`;
  }
  document.getElementById('ha-events').textContent = haEvents.toLocaleString();
  document.getElementById('marge-events').textContent = margeEvents.toLocaleString();
}

async function pollMargeHealth() {
  try {
    const r = await fetch(`${MARGE_REST}/health`);
    margeHealth = await r.json();
    // Sync sim-time and chapter from Marge health
    if (margeHealth.sim_time) simTimeStr = margeHealth.sim_time;
    if (margeHealth.sim_chapter && margeHealth.sim_chapter !== currentChapter) {
      const oldChapter = currentChapter;
      currentChapter = margeHealth.sim_chapter;
      if (oldChapter !== 'idle') {
        logEvent('sys', `Chapter: ${currentChapter.toUpperCase()}`, 'automation');
      }
    }
    if (margeHealth.sim_speed) {
      document.getElementById('speed-badge').textContent = margeHealth.sim_speed + 'x';
    }
    renderMetrics();
  } catch(e) { console.warn('Marge health poll failed:', e.message || e); }
}

async function pollHALatency() {
  try {
    const haToken = await loadHAToken();
    const t0 = performance.now();
    const r = await fetch(`${HA_REST}/`, {
      headers: haToken ? { 'Authorization': `Bearer ${haToken}` } : {}
    });
    if (r.ok) haLatencyMs = performance.now() - t0;
  } catch(e) { console.warn('HA latency poll failed:', e.message || e); }
}

// ── Event Log ───────────────────────────────

const DOMAIN_ICONS = {
  'light': '\uD83D\uDCA1', 'switch': '\u26A1', 'lock': '\uD83D\uDD12',
  'climate': '\uD83C\uDF21', 'alarm_control_panel': '\uD83D\uDEA8',
  'media_player': '\uD83C\uDFB5', 'automation': '\u2699\uFE0F',
  'binary_sensor': '\uD83D\uDCE1', 'sensor': '\uD83D\uDCCA',
  'scene': '\uD83C\uDFA8', 'button': '\uD83D\uDD18',
};

function logEvent(source, msg, type) {
  const log = document.getElementById('event-log');
  const time = new Date().toLocaleTimeString('en-US', { hour12: false });
  const srcClass = source === 'ha' ? 'ha' : source === 'sys' ? 'sys' : 'marge';
  const srcLabel = source === 'ha' ? 'HA' : source === 'sys' ? 'SYS' : 'MG';
  const entryClass = type === 'automation' ? ' automation' : type === 'outage' ? ' outage' : '';

  // Extract domain for icon
  const domainMatch = msg.match(/^(\w+)\./);
  const domain = domainMatch ? domainMatch[1] : '';
  const icon = DOMAIN_ICONS[domain] || '\u2022';

  const entry = document.createElement('div');
  entry.className = `log-entry${entryClass}`;
  entry.innerHTML = `<span class="log-time">${time}</span><span class="log-source ${srcClass}">${srcLabel}</span><span class="log-domain-icon">${icon}</span><span class="log-msg">${msg}</span>`;
  log.prepend(entry);
  while (log.children.length > 150) log.removeChild(log.lastChild);

  // Track event rate
  eventTimestamps.push(Date.now());
}

function getEventRate() {
  const now = Date.now();
  eventTimestamps = eventTimestamps.filter(t => now - t < 5000);
  return (eventTimestamps.length / 5).toFixed(1);
}

// ── Timeline ────────────────────────────────

let lastRenderedChapter = null;
function renderTimeline() {
  // Update fill based on sim time (every call)
  if (simTimeStr !== '--:--:--') {
    const parts = simTimeStr.split(':');
    const mins = parseInt(parts[0]) * 60 + parseInt(parts[1]);
    const pct = (mins / 1440) * 100;
    document.getElementById('timeline-fill').style.width = pct + '%';
  }

  // Only recreate chapter elements when chapter changes
  if (lastRenderedChapter === currentChapter) return;
  lastRenderedChapter = currentChapter;

  const chapEl = document.getElementById('timeline-chapters');
  chapEl.innerHTML = CHAPTERS.map(c =>
    `<span class="timeline-chapter ${c.name === currentChapter ? 'active' : ''}" style="border-left:3px solid ${c.color}">${c.name}</span>`
  ).join('');

  // Render chapter markers on the track
  const track = document.getElementById('timeline-track');
  track.querySelectorAll('.timeline-marker').forEach(m => m.remove());
  for (const c of CHAPTERS) {
    const [h, m] = c.start.split(':').map(Number);
    const pct = ((h * 60 + m) / 1440) * 100;
    const marker = document.createElement('div');
    marker.className = 'timeline-marker';
    marker.style.left = pct + '%';
    marker.style.background = c.color;
    marker.innerHTML = `<span class="timeline-marker-label">${c.name === currentChapter ? c.name : ''}</span>`;
    track.appendChild(marker);
  }
}

// ── Score Card ──────────────────────────────

function showScoreCard() {
  const h = margeHealth;
  const mem_marge = h.memory_rss_mb || 11;
  const lat_marge = h.latency_avg_us || 3.5;
  const changes_marge = h.state_changes || margeEvents;
  const startup_marge_ms = h.startup_ms || 0.5;
  // HA measured baselines (docker stats + /proc RSS)
  const mem_ha = 179;       // Stock HA RSS (MB)
  const mem_slim = 156;     // Slim HA RSS (MB)
  const lat_ha = haLatencyMs !== null ? haLatencyMs * 1000 : 23000;
  const startup_ha = 94;
  const startup_slim = 2.6; // seconds

  // Recovery time (live WS tracking, or fallback to driver-pushed sensor)
  const haRec = haRecoveryTime ?? (S['sensor.recovery_ha']?.state ? parseFloat(S['sensor.recovery_ha'].state) : null);
  const margeRec = margeRecoveryTime ?? (S['sensor.recovery_marge']?.state ? parseFloat(S['sensor.recovery_marge'].state) : null);
  const haRecStr = haRec !== null ? `${haRec.toFixed(1)}s` : '~94s';
  const margeRecStr = margeRec !== null ? `${margeRec.toFixed(1)}s` : `${startup_marge_ms.toFixed(1)} ms`;
  const recoveryRatio = haRec !== null && margeRec !== null
    ? `${(haRec / margeRec).toFixed(0)}x faster`
    : `${(startup_ha * 1000 / startup_marge_ms).toFixed(0)}x faster`;

  // [label, stock_ha, slim_ha, marge, ratio]
  const rows = [
    ['Docker Image',    '1.78 GB',    '605 MB',        '90 MB',                          '20x / 7x'],
    ['Memory (RSS)',    `${mem_ha} MB`,  `${mem_slim} MB`,  `${mem_marge.toFixed(1)} MB`,   `${(mem_ha / mem_marge).toFixed(0)}x smaller`],
    ['Startup Time',    `~${startup_ha}s`,  `~${startup_slim}s`, `${startup_marge_ms.toFixed(1)} ms`, `${(startup_ha * 1000 / startup_marge_ms).toFixed(0)}x faster`],
    ['Recovery Time',   haRecStr,    '\u2014',         margeRecStr,                       recoveryRatio],
    ['Avg Latency',     haLatencyMs !== null ? `${haLatencyMs.toFixed(0)} ms` : '~0.75 ms', '~0.75 ms', `${lat_marge.toFixed(1)} \u00B5s`, `${(lat_ha / lat_marge).toFixed(0)}x faster`],
    ['Verifications',   S['sensor.verify_ha']?.state || '17/21', '17/21', S['sensor.verify_marge']?.state || '21/21', 'Marge: 100%'],
    ['Packages shipped', '3,002',    '95',             '0 (static binary)',               '\u2014'],
    ['CTS Compat',      'Baseline',  'Baseline',       '77/77 passing',                   '100%'],
    ['Language',        'Python 3.12', 'Python 3.13',  'Rust',                            '\u2014'],
  ];

  const tbody = document.getElementById('sc-body');
  tbody.innerHTML = rows.map(([label, ha, slim, marge, ratio]) =>
    `<tr><td>${label}</td><td class="ha-col">${ha}</td><td class="slim-col">${slim}</td><td class="marge-col">${marge}</td><td class="ratio-col">${ratio}</td></tr>`
  ).join('');

  document.getElementById('scorecard-overlay').classList.add('visible');
}

function hideScoreCard() {
  document.getElementById('scorecard-overlay').classList.remove('visible');
}

document.addEventListener('keydown', (e) => {
  if (e.key === 's' || e.key === 'S') {
    const overlay = document.getElementById('scorecard-overlay');
    if (overlay.classList.contains('visible')) hideScoreCard();
    else showScoreCard();
  }
  if (e.key === '?') {
    const help = document.getElementById('help-overlay');
    help.classList.toggle('visible');
  }
  if (e.key === 'Escape') {
    hideScoreCard();
    document.getElementById('help-overlay').classList.remove('visible');
    document.getElementById('outage-overlay').classList.remove('visible');
    if (recoveryTimerInterval) clearInterval(recoveryTimerInterval);
  }
});

document.getElementById('scorecard-overlay').addEventListener('click', (e) => {
  if (e.target === document.getElementById('scorecard-overlay')) hideScoreCard();
});
document.getElementById('help-overlay').addEventListener('click', (e) => {
  if (e.target === document.getElementById('help-overlay')) {
    document.getElementById('help-overlay').classList.remove('visible');
  }
});

// ── Init ────────────────────────────────────

async function loadHAToken() {
  if (cachedHAToken !== null) return cachedHAToken;
  if (HA_TOKEN) { cachedHAToken = HA_TOKEN; return HA_TOKEN; }
  try {
    const r = await fetch('/ha-token.txt');
    if (r.ok) { cachedHAToken = (await r.text()).trim(); return cachedHAToken; }
  } catch(e) {}
  cachedHAToken = '';
  return '';
}

(async function init() {
  const haToken = await loadHAToken();
  connectWS(MARGE_WS, '', 'marge', S, () => margeEvents++);
  connectWS(HA_WS, haToken, 'ha', HA, () => haEvents++);

  setInterval(pollMargeHealth, 3000);
  pollMargeHealth();
  setInterval(pollHALatency, 5000);
  pollHALatency();

  setInterval(() => {
    document.getElementById('sim-time').textContent = simTimeStr;
    const badge = document.getElementById('chapter-badge');
    badge.textContent = currentChapter.toUpperCase() || 'IDLE';
    const chap = CHAPTERS.find(c => c.name === currentChapter);
    badge.style.background = chap ? chap.color : '#1a7f37';
    badge.style.color = ['night', 'goodnight'].includes(currentChapter) ? '#24292f' : '#fff';
    renderTimeline();
    // Update event rate
    const rate = getEventRate();
    document.getElementById('event-rate').textContent = rate > 0 ? `${rate}/s` : '';
  }, 1000);

  renderHouse();
  renderTimeline();

  // Auto-show score card if ?score query param present (wait for WS data)
  if (params.has('score')) setTimeout(showScoreCard, 4000);
})();
</script>

</body>
</html>
