<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Marge vs HA — Side-by-Side</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'SF Mono', 'Cascadia Code', monospace; background: #0d1117; color: #c9d1d9; }

.header {
  background: #161b22; border-bottom: 1px solid #30363d;
  padding: 12px 24px; display: flex; align-items: center; gap: 16px;
}
.header h1 { font-size: 18px; font-weight: 600; }
.header .status { font-size: 12px; padding: 2px 8px; border-radius: 12px; }
.status.connected { background: #1b4332; color: #2dd4bf; }
.status.disconnected { background: #3b1c1c; color: #f87171; }

.metrics-bar {
  background: #161b22; border-bottom: 1px solid #30363d;
  padding: 8px 24px; display: flex; gap: 32px; font-size: 12px; color: #8b949e;
}
.metric { display: flex; gap: 6px; }
.metric .label { color: #8b949e; }
.metric .value { color: #58a6ff; font-weight: 600; }

.container { display: flex; height: calc(100vh - 90px); }

.panel {
  flex: 1; overflow-y: auto; padding: 16px;
  border-right: 1px solid #30363d;
}
.panel:last-child { border-right: none; }
.panel-header {
  font-size: 14px; font-weight: 600; margin-bottom: 12px;
  padding-bottom: 8px; border-bottom: 1px solid #30363d;
  display: flex; justify-content: space-between; align-items: center;
}
.panel-header .sub { font-size: 11px; color: #8b949e; font-weight: 400; }

.diff-panel {
  flex: 0 0 300px; background: #161b22;
  overflow-y: auto; padding: 16px;
}

.entity-group { margin-bottom: 16px; }
.entity-group h3 {
  font-size: 11px; text-transform: uppercase; letter-spacing: 1px;
  color: #8b949e; margin-bottom: 6px;
}

.entity-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 4px 8px; border-radius: 4px; font-size: 12px;
  margin-bottom: 2px;
}
.entity-row:hover { background: #1c2128; }
.entity-row .name { color: #c9d1d9; flex: 1; }
.entity-row .state { font-weight: 600; min-width: 80px; text-align: right; }
.entity-row .state.on { color: #3fb950; }
.entity-row .state.off { color: #8b949e; }
.entity-row .state.locked { color: #f0883e; }
.entity-row .state.unlocked { color: #3fb950; }
.entity-row .state.armed_home, .entity-row .state.armed_away, .entity-row .state.armed_night { color: #f0883e; }
.entity-row .state.disarmed { color: #3fb950; }
.entity-row .state.heat, .entity-row .state.cool { color: #58a6ff; }

.diff-entry {
  padding: 6px 8px; border-radius: 4px; font-size: 11px;
  margin-bottom: 4px; background: #1c2128;
}
.diff-entry.match { border-left: 3px solid #3fb950; }
.diff-entry.mismatch { border-left: 3px solid #f85149; }
.diff-entry .entity { color: #58a6ff; }
.diff-entry .vals { display: flex; gap: 8px; margin-top: 2px; }
.diff-entry .ha-val { color: #8b949e; }
.diff-entry .marge-val { color: #c9d1d9; }

.event-log {
  max-height: 200px; overflow-y: auto; font-size: 11px;
  background: #0d1117; border: 1px solid #30363d; border-radius: 6px;
  padding: 8px; margin-top: 12px;
}
.event-log .entry { padding: 2px 0; border-bottom: 1px solid #21262d; }
.event-log .time { color: #8b949e; }
.event-log .auto { color: #d2a8ff; }
</style>
</head>
<body>

<div class="header">
  <h1>Marge vs HA</h1>
  <span id="ha-status" class="status disconnected">HA: disconnected</span>
  <span id="marge-status" class="status disconnected">Marge: disconnected</span>
  <span style="flex:1"></span>
  <span style="font-size:12px;color:#8b949e" id="clock"></span>
</div>

<div class="metrics-bar">
  <div class="metric">
    <span class="label">Marge RSS:</span>
    <span class="value" id="marge-rss">—</span>
  </div>
  <div class="metric">
    <span class="label">Marge Entities:</span>
    <span class="value" id="marge-entities">—</span>
  </div>
  <div class="metric">
    <span class="label">Marge Uptime:</span>
    <span class="value" id="marge-uptime">—</span>
  </div>
  <div class="metric">
    <span class="label">Events/s:</span>
    <span class="value" id="events-per-sec">0</span>
  </div>
  <div class="metric">
    <span class="label">Diffs:</span>
    <span class="value" id="diff-count">0</span>
  </div>
</div>

<div class="container">
  <div class="panel" id="ha-panel">
    <div class="panel-header">
      Home Assistant <span class="sub">:8123</span>
    </div>
    <div id="ha-entities"></div>
  </div>
  <div class="panel" id="marge-panel">
    <div class="panel-header">
      Marge <span class="sub">:8124</span>
    </div>
    <div id="marge-entities"></div>
  </div>
  <div class="diff-panel">
    <div class="panel-header">
      State Diffs <span class="sub" id="diff-summary"></span>
    </div>
    <div id="diff-list"></div>
    <div class="panel-header" style="margin-top:16px">
      Automation Log
    </div>
    <div class="event-log" id="event-log"></div>
  </div>
</div>

<script>
// Configuration — override via query params or env
const params = new URLSearchParams(location.search);
const HA_WS = params.get('ha_ws') || 'ws://localhost:8123/api/websocket';
const MARGE_WS = params.get('marge_ws') || 'ws://localhost:8124/api/websocket';
const MARGE_REST = params.get('marge_rest') || 'http://localhost:8124/api';
const HA_TOKEN = params.get('ha_token') || '';

// Entity order for display
const DOMAIN_ORDER = [
  'light', 'switch', 'lock', 'climate', 'alarm_control_panel',
  'binary_sensor', 'sensor', 'automation', 'scene'
];

const haStates = {};
const margeStates = {};
let eventCount = 0;
let lastEventTime = Date.now();

// ── WebSocket Connection ──────────────────────────

function connectWS(url, token, name, onState) {
  const statusEl = document.getElementById(`${name}-status`);
  let ws;

  function connect() {
    ws = new WebSocket(url);
    ws.onopen = () => {};

    ws.onmessage = (evt) => {
      const msg = JSON.parse(evt.data);

      if (msg.type === 'auth_required') {
        ws.send(JSON.stringify({ type: 'auth', access_token: token || 'test-token' }));
      } else if (msg.type === 'auth_ok') {
        statusEl.className = 'status connected';
        statusEl.textContent = `${name}: connected`;
        // Subscribe to state changes
        ws.send(JSON.stringify({ id: 1, type: 'subscribe_events', event_type: 'state_changed' }));
        // Get initial states
        ws.send(JSON.stringify({ id: 2, type: 'get_states' }));
      } else if (msg.type === 'result' && msg.id === 2 && msg.result) {
        // Initial state dump
        for (const s of msg.result) {
          onState(s.entity_id, s.state, s.attributes || {});
        }
        renderAll();
      } else if (msg.type === 'event' && msg.event?.event_type === 'state_changed') {
        const d = msg.event.data;
        if (d.new_state) {
          onState(d.new_state.entity_id, d.new_state.state, d.new_state.attributes || {});
          eventCount++;
          renderAll();

          // Log automation events
          if (d.new_state.entity_id.startsWith('automation.')) {
            logEvent(`${d.new_state.entity_id} → ${d.new_state.state}`);
          }
        }
      }
    };

    ws.onclose = () => {
      statusEl.className = 'status disconnected';
      statusEl.textContent = `${name}: disconnected`;
      setTimeout(connect, 3000);
    };

    ws.onerror = () => ws.close();
  }

  connect();
}

// ── Rendering ──────────────────────────

function groupByDomain(states) {
  const groups = {};
  for (const [eid, data] of Object.entries(states)) {
    const domain = eid.split('.')[0];
    if (!groups[domain]) groups[domain] = [];
    groups[domain].push({ entity_id: eid, ...data });
  }
  return groups;
}

function renderPanel(containerId, states) {
  const el = document.getElementById(containerId);
  const groups = groupByDomain(states);
  let html = '';

  for (const domain of DOMAIN_ORDER) {
    if (!groups[domain]) continue;
    const entities = groups[domain].sort((a, b) => a.entity_id.localeCompare(b.entity_id));
    html += `<div class="entity-group"><h3>${domain} (${entities.length})</h3>`;
    for (const e of entities) {
      const name = e.entity_id.split('.').slice(1).join('.');
      const stateClass = e.state.replace(/\s/g, '_');
      let display = e.state;
      if (e.attrs?.brightness) display += ` (${e.attrs.brightness})`;
      if (e.attrs?.temperature) display += ` ${e.attrs.temperature}°`;
      if (e.attrs?.unit_of_measurement) display += ` ${e.attrs.unit_of_measurement}`;
      html += `<div class="entity-row"><span class="name">${name}</span><span class="state ${stateClass}">${display}</span></div>`;
    }
    html += '</div>';
  }

  el.innerHTML = html;
}

function renderDiffs() {
  const diffList = document.getElementById('diff-list');
  const allIds = new Set([...Object.keys(haStates), ...Object.keys(margeStates)]);
  let matches = 0, mismatches = 0;
  let html = '';

  // Only compare entities that exist in both
  const demoEntities = [...allIds].filter(id =>
    !id.startsWith('test.') && !id.startsWith('persistent_notification.')
  ).sort();

  for (const eid of demoEntities) {
    const ha = haStates[eid];
    const marge = margeStates[eid];
    if (!ha || !marge) continue;

    if (ha.state === marge.state) {
      matches++;
    } else {
      mismatches++;
      const name = eid.split('.').slice(1).join('.');
      html += `<div class="diff-entry mismatch">
        <div class="entity">${eid}</div>
        <div class="vals">
          <span class="ha-val">HA: ${ha.state}</span>
          <span class="marge-val">Marge: ${marge.state}</span>
        </div>
      </div>`;
    }
  }

  diffList.innerHTML = html || '<div style="color:#8b949e;font-size:12px;padding:8px">No diffs</div>';
  document.getElementById('diff-count').textContent = mismatches;
  document.getElementById('diff-summary').textContent = `${matches} match, ${mismatches} diff`;
}

function renderAll() {
  renderPanel('ha-entities', haStates);
  renderPanel('marge-entities', margeStates);
  renderDiffs();
}

function logEvent(msg) {
  const log = document.getElementById('event-log');
  const time = new Date().toLocaleTimeString();
  log.innerHTML = `<div class="entry"><span class="time">${time}</span> <span class="auto">${msg}</span></div>` + log.innerHTML;
  // Keep last 100
  while (log.children.length > 100) log.removeChild(log.lastChild);
}

// ── Metrics Polling ──────────────────────────

async function pollMetrics() {
  try {
    const resp = await fetch(`${MARGE_REST}/health`);
    const data = await resp.json();
    document.getElementById('marge-rss').textContent = `${(data.memory_rss_kb / 1024).toFixed(1)} MB`;
    document.getElementById('marge-entities').textContent = data.entity_count;
    document.getElementById('marge-uptime').textContent = `${data.uptime_seconds}s`;
  } catch (e) {}
}

// Events per second counter
setInterval(() => {
  const now = Date.now();
  const elapsed = (now - lastEventTime) / 1000;
  if (elapsed > 0) {
    document.getElementById('events-per-sec').textContent = Math.round(eventCount / Math.max(elapsed, 1));
  }
  eventCount = 0;
  lastEventTime = now;
}, 2000);

// Clock
setInterval(() => {
  document.getElementById('clock').textContent = new Date().toLocaleTimeString();
}, 1000);

// ── Init ──────────────────────────

connectWS(HA_WS, HA_TOKEN, 'ha', (eid, state, attrs) => {
  haStates[eid] = { state, attrs };
});

connectWS(MARGE_WS, '', 'marge', (eid, state, attrs) => {
  margeStates[eid] = { state, attrs };
});

setInterval(pollMetrics, 5000);
pollMetrics();
</script>

</body>
</html>
